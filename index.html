<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Equipes - Sistema Multi-Usu√°rio</title>
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Gest√£o de Equipes">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: #f5f7fa; }
        
        /* AUTH SCREEN */
        .auth-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .auth-container { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 100%; max-width: 400px; }
        .auth-container h2 { margin-bottom: 20px; color: #2c3e50; }
        .auth-container label { display: block; margin-top: 15px; color: #555; }
        .auth-container input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; }
        .auth-container button { width: 100%; padding: 12px; margin-top: 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .auth-container button:hover { background: #5568d3; }
        .auth-container a { display: block; margin-top: 15px; text-align: center; color: #667eea; text-decoration: none; }
        .erro { color: red; margin-top: 10px; font-size: 14px; }
        .sucesso { color: green; margin-top: 10px; font-size: 14px; }
        
        /* DASHBOARD */
        .dashboard { display: flex; height: 100vh; }
        .sidebar { width: 280px; background: #2c3e50; color: white; overflow-y: auto; padding: 15px; }
        .sidebar h1 { font-size: 16px; margin-bottom: 10px; }
        .sidebar h3 { margin-top: 12px; margin-bottom: 8px; font-size: 12px; color: #bdc3c7; }
        .sidebar input, .sidebar select { width: 100%; padding: 6px; margin: 3px 0; border: none; border-radius: 3px; font-size: 12px; }
        .sidebar button { width: 100%; padding: 8px; margin: 5px 0; background: #667eea; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; }
        .sidebar button:hover { background: #5568d3; }
        .lista-item { background: #34495e; padding: 8px; margin: 4px 0; border-radius: 3px; font-size: 11px; }
        .lista-item button { width: auto; padding: 4px 8px; font-size: 10px; margin: 2px 2px 2px 0; }
        .role-badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 9px; margin-left: 5px; }
        .role-admin { background: #e74c3c; color: white; }
        .role-lider { background: #f39c12; color: white; }
        .role-membro { background: #3498db; color: white; }
        
        /* MAIN CONTENT */
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .header { background: white; padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { color: #2c3e50; font-size: 16px; }
        .header button { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-left: 5px; font-size: 12px; }
        .user-info { font-size: 11px; color: #7f8c8d; margin-right: 10px; }
        
        .content { flex: 1; display: flex; }
        #map { flex: 1; background: #eee; }
        .controls { width: 200px; background: white; border-left: 1px solid #eee; padding: 12px; overflow-y: auto; font-size: 12px; }
        .controle-grupo { margin-bottom: 10px; }
        .controle-grupo label { display: block; margin-bottom: 3px; color: #555; font-weight: bold; font-size: 11px; }
        .controle-grupo button { width: 100%; padding: 6px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer; margin: 2px 0; font-size: 11px; }
        .controle-grupo button:hover { background: #2980b9; }
        
        .legenda { background: #f5f5f5; padding: 8px; border-radius: 3px; margin: 8px 0; font-size: 11px; }
        .legenda-item { margin: 3px 0; }
        .status-badge { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        
        .info-gps { background: #e8f5e9; padding: 8px; border-radius: 3px; margin: 8px 0; font-size: 10px; color: #2e7d32; }
        
        /* MOBILE OTIMIZADO */
        @media (max-width: 768px) {
            .dashboard { flex-direction: column; }
            .sidebar { width: 100%; max-height: 150px; padding: 10px; }
            .sidebar h3 { display: none; }
            .sidebar input, .sidebar select { font-size: 11px; padding: 5px; margin: 2px 0; }
            .sidebar button { padding: 6px; font-size: 10px; margin: 3px 0; }
            .lista-item { display: none; }
            .controls { width: 100%; max-height: 100px; padding: 8px; }
            .header { padding: 10px; }
            .header h1 { font-size: 14px; }
            .header button { padding: 6px 10px; font-size: 10px; margin-left: 3px; }
            .content { flex-direction: column; }
            #map { height: 55vh; }
            .controle-grupo button { padding: 5px; font-size: 10px; margin: 1px 0; }
        }
    </style>
</head>
<body>

<!-- TELA DE AUTENTICA√á√ÉO -->
<div id="auth-screen" class="auth-screen">
    <div class="auth-container">
        <div id="login-view">
            <h2>üîê Login</h2>
            <form id="login-form">
                <label>E-mail:</label>
                <input type="email" id="login-email" required>
                <label>Senha:</label>
                <input type="password" id="login-password" required>
                <button type="submit">Entrar</button>
                <a href="#" id="link-cadastro">Primeira vez? Cadastre-se</a>
                <div id="login-erro" class="erro"></div>
            </form>
        </div>
        
        <div id="register-view" style="display:none">
            <h2>üìù Cadastro</h2>
            <form id="register-form">
                <label>Nome Completo:</label>
                <input type="text" id="register-nome" required>
                <label>E-mail:</label>
                <input type="email" id="register-email" required>
                <label>Senha:</label>
                <input type="password" id="register-password" required>
                <label>C√≥digo da Empresa (deixe vazio para criar nova):</label>
                <input type="text" id="register-empresa-codigo" placeholder="Ex: ABC123">
                <button type="submit">Cadastrar</button>
                <a href="#" id="link-login">Voltar ao login</a>
                <div id="register-erro" class="erro"></div>
                <div id="register-sucesso" class="sucesso"></div>
            </form>
        </div>
    </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="dashboard" style="display:none">
    <div class="sidebar">
        <h1>üìç Gest√£o de Equipes</h1>
        <div style="background: #34495e; padding: 6px; border-radius: 3px; margin: 5px 0; font-size: 10px;">
            <div><b id="user-nome">Usu√°rio</b> <span id="user-role-badge"></span></div>
            <div style="color: #bdc3c7; margin-top: 3px;">Empresa: <span id="empresa-nome">Carregando...</span></div>
            <div style="color: #bdc3c7;">C√≥digo: <span id="empresa-codigo">---</span></div>
        </div>
        <button id="logout-btn" style="background: #e74c3c;">Sair</button>
        
        <!-- ADMIN/L√çDER: Criar Pontos -->
        <div id="admin-pontos-section" style="display:none;">
            <h3>üìç Novo Ponto</h3>
            <input type="text" id="ponto-nome" placeholder="Nome">
            <input type="number" id="ponto-lat" placeholder="Lat" step="0.0001">
            <input type="number" id="ponto-lng" placeholder="Lng" step="0.0001">
            <button id="adicionar-ponto">+ Adicionar Ponto</button>
        </div>
        
        <!-- ADMIN: Criar Equipes -->
        <div id="admin-equipes-section" style="display:none;">
            <h3>üë• Nova Equipe</h3>
            <input type="text" id="equipe-nome" placeholder="Nome da equipe">
            <select id="equipe-lider"><option value="">Selecione l√≠der</option></select>
            <select id="equipe-destino"><option value="">Selecione destino</option></select>
            <button id="criar-equipe">+ Criar Equipe</button>
        </div>
        
        <!-- ADMIN: Gerenciar Usu√°rios -->
        <div id="admin-usuarios-section" style="display:none;">
            <h3>üë§ Usu√°rios</h3>
            <div id="lista-usuarios"></div>
        </div>
        
        <h3>üìç Pontos</h3>
        <div id="lista-pontos"></div>
        
        <h3>üë• Equipes</h3>
        <div id="lista-equipes"></div>
    </div>
    
    <div class="main-content">
        <div class="header">
            <h1>üó∫Ô∏è Monitoramento em Tempo Real</h1>
            <div style="display: flex; align-items: center;">
                <span class="user-info" id="header-user-info"></span>
                <button id="iniciar-rastreamento">‚ñ∂Ô∏è Iniciar</button>
                <button id="parar-rastreamento" style="background: #f39c12;">‚è∏Ô∏è Pausar</button>
            </div>
        </div>
        
        <div class="content">
            <div id="map" style="flex: 1;"></div>
            <div class="controls">
                <div class="info-gps">
                    üìç GPS: <span id="gps-status">Aguardando...</span>
                </div>
                
                <h3>üö¶ Tr√¢nsito</h3>
                <select id="traffic-equipe-select" style="width: 100%; padding: 4px; margin: 3px 0; border: 1px solid #ddd; border-radius: 3px; font-size: 10px;">
                    <option value="">Sua localiza√ß√£o</option>
                </select>
                <div id="traffic-status" style="font-size: 11px;"></div>
                <div style="font-size: 9px; color: #666; margin-top: 5px;">
                    <small>Local: <span id="traffic-location">Aguardando...</span></small>
                </div>
                
                <h3>üéÆ Controles</h3>
                <div class="controle-grupo">
                    <button id="centralizar-mapa">üìç Centro</button>
                    <button id="mostrar-usuario">üë§ Eu</button>
                    <button id="mostrar-pontos">üìå Pontos</button>
                    <button id="mostrar-equipes">üë• Equipes</button>
                    <button id="mostrar-todos">üåç Tudo</button>
                    <button id="calcular-distancias">üìè Dist√¢ncias</button>
                    <button id="limpar-mapa">üóëÔ∏è Limpar</button>
                </div>
                
                <div id="distancias-info" style="display:none; background: #e3f2fd; padding: 8px; border-radius: 3px; margin: 8px 0; font-size: 10px; max-height: 150px; overflow-y: auto;">
                    <h4 style="margin-bottom: 5px;">üìè Dist√¢ncias</h4>
                    <div id="lista-distancias"></div>
                </div>
                
                <div class="legenda">
                    <h4>Legenda</h4>
                    <div class="legenda-item">
                        <span class="status-badge" style="background: #3498db;"></span> Voc√™
                    </div>
                    <div class="legenda-item">
                        <span class="status-badge" style="background: #667eea;"></span> Pontos
                    </div>
                    <div class="legenda-item">
                        <span class="status-badge" style="background: #27ae60;"></span> Online
                    </div>
                    <div class="legenda-item">
                        <span class="status-badge" style="background: #f39c12;"></span> Em rota
                    </div>
                    <div class="legenda-item">
                        <span class="status-badge" style="background: #e74c3c;"></span> Offline
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDFEYVVRPjxUvO7zDsG3RqmdmAgTur_bP4",
  authDomain: "geoequipes-trafego.firebaseapp.com",
  projectId: "geoequipes-trafego",
  storageBucket: "geoequipes-trafego.appspot.com",
  messagingSenderId: "806195713051",
  appId: "1:806195713051:web:ea0cfd0b070a0d2673d4be"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let mapa;
let usuarioAtual = null;
let empresaAtual = null;
let perfilUsuario = null;
let rastreando = false;
let pontosMarkers = {};
let equipesMarkers = {};
let usuariosMarkers = {};
let usuarioMarker = null;
let pontosDados = [];
let equipasDados = [];
let usuariosDados = [];
let localizacaoAtual = null;
let watchId = null;

// GERADOR DE C√ìDIGO DE EMPRESA
function gerarCodigoEmpresa() {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
}

// Aguardar DOM carregar
document.addEventListener('DOMContentLoaded', function() {
    
// ALTERN√ÇNCIA LOGIN/CADASTRO
document.getElementById('link-cadastro').onclick = (e) => {
    e.preventDefault();
    document.getElementById('login-view').style.display = 'none';
    document.getElementById('register-view').style.display = 'block';
};

document.getElementById('link-login').onclick = (e) => {
    e.preventDefault();
    document.getElementById('login-view').style.display = 'block';
    document.getElementById('register-view').style.display = 'none';
};

// LOGIN
document.getElementById('login-form').onsubmit = async (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    try {
        await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
        document.getElementById('login-erro').textContent = error.message;
    }
};

// CADASTRO
document.getElementById('register-form').onsubmit = async (e) => {
    e.preventDefault();
    const nome = document.getElementById('register-nome').value;
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const codigoEmpresa = document.getElementById('register-empresa-codigo').value.trim();
    
    try {
        // Criar conta
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        let empresaId = null;
        let role = 'membro';
        let nomeEmpresa = '';
        let codigoFinal = '';
        
        if (codigoEmpresa) {
            // Buscar empresa pelo c√≥digo
            const empresasSnapshot = await db.collection('empresas')
                .where('codigo', '==', codigoEmpresa.toUpperCase())
                .get();
            
            if (empresasSnapshot.empty) {
                throw new Error('C√≥digo de empresa n√£o encontrado');
            }
            
            empresaId = empresasSnapshot.docs[0].id;
            nomeEmpresa = empresasSnapshot.docs[0].data().nome;
            codigoFinal = codigoEmpresa.toUpperCase();
        } else {
            // Criar nova empresa
            codigoFinal = gerarCodigoEmpresa();
            const novaEmpresa = await db.collection('empresas').add({
                nome: `Empresa de ${nome}`,
                codigo: codigoFinal,
                criadoEm: new Date(),
                criadoPor: user.uid
            });
            empresaId = novaEmpresa.id;
            nomeEmpresa = `Empresa de ${nome}`;
            role = 'admin'; // Primeiro usu√°rio √© admin
        }
        
        // Criar perfil do usu√°rio
        await db.collection('empresas').doc(empresaId).collection('usuarios').doc(user.uid).set({
            nome: nome,
            email: email,
            role: role,
            criadoEm: new Date(),
            localizacaoAtual: null,
            status: 'offline',
            equipeId: null
        });
        
        document.getElementById('register-sucesso').textContent = 
            `‚úÖ Conta criada! ${role === 'admin' ? `Seu c√≥digo: ${codigoFinal}` : 'Bem-vindo!'}`;
        document.getElementById('register-erro').textContent = '';
        
        setTimeout(() => {
            document.getElementById('login-view').style.display = 'block';
            document.getElementById('register-view').style.display = 'none';
        }, 2000);
        
    } catch (error) {
        document.getElementById('register-erro').textContent = error.message;
        document.getElementById('register-sucesso').textContent = '';
    }
};

// LOGOUT
document.getElementById('logout-btn').onclick = () => {
    auth.signOut();
};

// MONITORAR AUTENTICA√á√ÉO
auth.onAuthStateChanged(async user => {
    usuarioAtual = user;
    if (user) {
        await carregarPerfilEmpresa();
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'flex';
        setTimeout(() => inicializarMapa(), 100);
        await carregarDados();
        iniciarGeolocaliza√ß√£o();
        monitorarLocalizacoesRealTime();
        atualizarTrafegoEmTempoReal();
    } else {
        document.getElementById('auth-screen').style.display = 'flex';
        document.getElementById('dashboard').style.display = 'none';
        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
        }
    }
});

// CARREGAR PERFIL E EMPRESA
async function carregarPerfilEmpresa() {
    try {
        // Buscar empresa do usu√°rio
        const empresasSnapshot = await db.collection('empresas').get();
        let encontrou = false;
        
        for (const empresaDoc of empresasSnapshot.docs) {
            const usuarioDoc = await db.collection('empresas')
                .doc(empresaDoc.id)
                .collection('usuarios')
                .doc(usuarioAtual.uid)
                .get();
            
            if (usuarioDoc.exists) {
                empresaAtual = empresaDoc.id;
                perfilUsuario = usuarioDoc.data();
                const empresaData = empresaDoc.data();
                
                // Atualizar UI
                document.getElementById('user-nome').textContent = perfilUsuario.nome;
                document.getElementById('empresa-nome').textContent = empresaData.nome;
                document.getElementById('empresa-codigo').textContent = empresaData.codigo;
                document.getElementById('header-user-info').textContent = `${perfilUsuario.nome} (${perfilUsuario.role})`;
                
                // Role badge
                const roleBadge = document.getElementById('user-role-badge');
                roleBadge.textContent = perfilUsuario.role.toUpperCase();
                roleBadge.className = `role-badge role-${perfilUsuario.role}`;
                
                // Mostrar/esconder se√ß√µes por permiss√£o
                if (perfilUsuario.role === 'admin') {
                    document.getElementById('admin-pontos-section').style.display = 'block';
                    document.getElementById('admin-equipes-section').style.display = 'block';
                    document.getElementById('admin-usuarios-section').style.display = 'block';
                } else if (perfilUsuario.role === 'lider') {
                    document.getElementById('admin-pontos-section').style.display = 'block';
                }
                
                encontrou = true;
                break;
            }
        }
        
        if (!encontrou) {
            alert('Erro: Perfil n√£o encontrado. Fa√ßa logout e cadastre-se novamente.');
            auth.signOut();
        }
    } catch (error) {
        console.error('Erro ao carregar perfil:', error);
    }
}

// CARREGAR TODOS OS DADOS
async function carregarDados() {
    await carregarPontos();
    await carregarEquipes();
    await carregarUsuarios();
    atualizarSelectsAdmin();
}

// PONTOS
document.getElementById('adicionar-ponto').onclick = async () => {
    if (!['admin', 'lider'].includes(perfilUsuario.role)) {
        alert('Apenas administradores e l√≠deres podem criar pontos');
        return;
    }
    
    const nome = document.getElementById('ponto-nome').value;
    const lat = parseFloat(document.getElementById('ponto-lat').value);
    const lng = parseFloat(document.getElementById('ponto-lng').value);
    
    if (!nome || !lat || !lng || isNaN(lat) || isNaN(lng)) {
        alert('Preencha todos os campos corretamente');
        return;
    }
    
    try {
        await db.collection('empresas').doc(empresaAtual).collection('pontos').add({
            nome, lat, lng, 
            criadoPor: usuarioAtual.uid,
            criadoEm: new Date()
        });
        document.getElementById('ponto-nome').value = '';
        document.getElementById('ponto-lat').value = '';
        document.getElementById('ponto-lng').value = '';
        carregarPontos();
    } catch (error) {
        console.error('Erro ao adicionar ponto:', error);
        alert('Erro ao adicionar ponto');
    }
};

async function carregarPontos() {
    if (!empresaAtual) {
        console.log('‚ö†Ô∏è empresaAtual n√£o definida ainda');
        return;
    }
    
    try {
        console.log('üîç Buscando pontos em:', `empresas/${empresaAtual}/pontos`);
        const snapshot = await db.collection('empresas').doc(empresaAtual).collection('pontos').get();
        document.getElementById('lista-pontos').innerHTML = '';
        pontosDados = [];
        
        console.log('üìå Total de pontos encontrados:', snapshot.size);
        
        snapshot.forEach(doc => {
            const ponto = doc.data();
            pontosDados.push({ id: doc.id, ...ponto });
            console.log('‚úÖ Ponto carregado:', ponto.nome);
            
            const div = document.createElement('div');
            div.className = 'lista-item';
            div.innerHTML = `<b>üìç ${ponto.nome}</b><br><small>${ponto.lat.toFixed(3)}, ${ponto.lng.toFixed(3)}</small>`;
            
            if (perfilUsuario && perfilUsuario.role === 'admin') {
                const btnRemover = document.createElement('button');
                btnRemover.textContent = 'Remover';
                btnRemover.onclick = () => removerPonto(doc.id);
                div.appendChild(btnRemover);
            }
            
            document.getElementById('lista-pontos').appendChild(div);
        });
        
        console.log('üìä Total de pontos em mem√≥ria:', pontosDados.length);
    } catch (error) {
        console.error('‚ùå Erro ao carregar pontos:', error);
        console.error('Detalhes:', error.message);
    }
}

async function removerPonto(id) {
    if (confirm('Remover este ponto?')) {
        await db.collection('empresas').doc(empresaAtual).collection('pontos').doc(id).delete();
        carregarPontos();
    }
}

// EQUIPES
document.getElementById('criar-equipe').onclick = async () => {
    if (perfilUsuario.role !== 'admin') {
        alert('Apenas administradores podem criar equipes');
        return;
    }
    
    const nome = document.getElementById('equipe-nome').value;
    const liderId = document.getElementById('equipe-lider').value;
    const destinoId = document.getElementById('equipe-destino').value;
    
    if (!nome || !liderId || !destinoId) {
        alert('Preencha todos os campos');
        return;
    }
    
    try {
        const pontoDestino = pontosDados.find(p => p.id === destinoId);
        
        await db.collection('empresas').doc(empresaAtual).collection('equipes').add({
            nome, 
            liderId,
            destinoId,
            pontoDestino: { lat: pontoDestino.lat, lng: pontoDestino.lng },
            membrosIds: [liderId],
            criadoEm: new Date()
        });
        
        // Atualizar role do l√≠der e vincular √† equipe
        await db.collection('empresas').doc(empresaAtual).collection('usuarios').doc(liderId).update({
            role: 'lider'
        });
        
        document.getElementById('equipe-nome').value = '';
        carregarEquipes();
        carregarUsuarios();
    } catch (error) {
        console.error('Erro ao criar equipe:', error);
        alert('Erro ao criar equipe');
    }
};

async function carregarEquipes() {
    try {
        const snapshot = await db.collection('empresas').doc(empresaAtual).collection('equipes').get();
        document.getElementById('lista-equipes').innerHTML = '';
        equipasDados = [];
        
        snapshot.forEach(doc => {
            const equipe = doc.data();
            equipasDados.push({ id: doc.id, ...equipe });
            
            const lider = usuariosDados.find(u => u.id === equipe.liderId);
            const nomeLider = lider ? lider.nome : 'L√≠der';
            
            const div = document.createElement('div');
            div.className = 'lista-item';
            div.innerHTML = `<b>üë• ${equipe.nome}</b><br><small>L√≠der: ${nomeLider}</small>`;
            document.getElementById('lista-equipes').appendChild(div);
        });
        
        atualizarSelectTrafegoEquipes();
    } catch (error) {
        console.error('Erro ao carregar equipes:', error);
    }
}

// USU√ÅRIOS
async function carregarUsuarios() {
    try {
        const snapshot = await db.collection('empresas').doc(empresaAtual).collection('usuarios').get();
        usuariosDados = [];
        
        snapshot.forEach(doc => {
            const usuario = doc.data();
            usuariosDados.push({ id: doc.id, ...usuario });
        });
        
        if (perfilUsuario.role === 'admin') {
            const lista = document.getElementById('lista-usuarios');
            lista.innerHTML = '';
            
            usuariosDados.forEach(usuario => {
                const div = document.createElement('div');
                div.className = 'lista-item';
                const roleBadge = `<span class="role-badge role-${usuario.role}">${usuario.role}</span>`;
                div.innerHTML = `<b>${usuario.nome}</b> ${roleBadge}<br><small>${usuario.email}</small>`;
                lista.appendChild(div);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar usu√°rios:', error);
    }
}

function atualizarSelectsAdmin() {
    // Select de l√≠deres
    const selectLider = document.getElementById('equipe-lider');
    selectLider.innerHTML = '<option value="">Selecione l√≠der</option>';
    usuariosDados.filter(u => u.role === 'membro').forEach(usuario => {
        const option = document.createElement('option');
        option.value = usuario.id;
        option.textContent = usuario.nome;
        selectLider.appendChild(option);
    });
    
    // Select de destinos
    const selectDestino = document.getElementById('equipe-destino');
    selectDestino.innerHTML = '<option value="">Selecione destino</option>';
    pontosDados.forEach(ponto => {
        const option = document.createElement('option');
        option.value = ponto.id;
        option.textContent = ponto.nome;
        selectDestino.appendChild(option);
    });
}

// GEOLOCALIZA√á√ÉO
function iniciarGeolocaliza√ß√£o() {
    if ('geolocation' in navigator) {
        document.getElementById('gps-status').textContent = 'Conectando...';
        
        watchId = navigator.geolocation.watchPosition(
            (position) => {
                localizacaoAtual = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };
                
                document.getElementById('gps-status').textContent = `üü¢ Online (${localizacaoAtual.accuracy.toFixed(0)}m)`;
                
                atualizarMarkerUsuario();
                atualizarLocalizacaoNoFirebase();
                atualizarTrafegoEmTempoReal();
            },
            (error) => {
                document.getElementById('gps-status').textContent = '‚ö†Ô∏è Erro GPS';
                console.error('Erro GPS:', error.message);
            },
            { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
        );
    }
}

async function atualizarLocalizacaoNoFirebase() {
    if (!localizacaoAtual || !empresaAtual) return;
    
    try {
        await db.collection('empresas').doc(empresaAtual).collection('usuarios').doc(usuarioAtual.uid).update({
            localizacaoAtual: localizacaoAtual,
            status: 'online',
            ultimaAtualizacao: new Date()
        });
    } catch (error) {
        console.error('Erro ao atualizar localiza√ß√£o:', error);
    }
}

function monitorarLocalizacoesRealTime() {
    setInterval(async () => {
        if (!rastreando) return;
        
        try {
            const snapshot = await db.collection('empresas').doc(empresaAtual).collection('usuarios').get();
            
            snapshot.forEach(async doc => {
                const usuario = doc.data();
                const ultimaAtualizacao = usuario.ultimaAtualizacao ? new Date(usuario.ultimaAtualizacao.toDate()).getTime() : 0;
                const agora = new Date().getTime();
                
                if (agora - ultimaAtualizacao > 30000 && usuario.status !== 'offline') {
                    await db.collection('empresas').doc(empresaAtual).collection('usuarios').doc(doc.id).update({
                        status: 'offline'
                    });
                }
            });
            
            carregarUsuarios();
        } catch (error) {
            console.error('Erro ao monitorar:', error);
        }
    }, 5000);
}

// MAPA
function inicializarMapa() {
    if (mapa) return;
    
    mapa = L.map('map').setView([-23.5505, -46.6333], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap',
        maxZoom: 19
    }).addTo(mapa);
    
    // M√∫ltiplas tentativas de redimensionar o mapa
    setTimeout(() => {
        if (mapa) {
            mapa.invalidateSize();
        }
    }, 200);
    
    setTimeout(() => {
        if (mapa) {
            mapa.invalidateSize();
        }
    }, 500);
    
    setTimeout(() => {
        if (mapa) {
            mapa.invalidateSize();
        }
    }, 1000);
}

function atualizarMarkerUsuario() {
    if (!localizacaoAtual || !mapa) return;
    
    if (usuarioMarker) mapa.removeLayer(usuarioMarker);
    
    usuarioMarker = L.marker([localizacaoAtual.lat, localizacaoAtual.lng], {
        icon: L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        })
    }).addTo(mapa).bindPopup(`<b>üë§ ${perfilUsuario.nome}</b><br>Voc√™ est√° aqui`);
}

function mostrarPontosNoMapa() {
    Object.values(pontosMarkers).forEach(m => mapa.removeLayer(m));
    pontosMarkers = {};
    
    console.log('üìå Tentando plotar pontos:', pontosDados.length);
    
    if (pontosDados.length === 0) {
        alert('‚ùå Nenhum ponto cadastrado. Adicione pontos primeiro!');
        return;
    }
    
    pontosDados.forEach(ponto => {
        console.log(`üìç Plotando: ${ponto.nome} em (${ponto.lat}, ${ponto.lng})`);
        
        // Usar √≠cone padr√£o do Leaflet com cor customizada
        const marker = L.marker([ponto.lat, ponto.lng], {
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })
        }).addTo(mapa).bindPopup(`<b>üìç ${ponto.nome}</b>`);
        pontosMarkers[ponto.id] = marker;
    });
    
    if (Object.keys(pontosMarkers).length > 0) {
        const group = new L.featureGroup(Object.values(pontosMarkers));
        mapa.fitBounds(group.getBounds().pad(0.1));
        alert(`‚úÖ ${pontosDados.length} ponto(s) exibido(s) no mapa!`);
        console.log('‚úÖ Pontos plotados com sucesso!');
    }
}

function mostrarEquipesNoMapa() {
    Object.values(usuariosMarkers).forEach(m => mapa.removeLayer(m));
    usuariosMarkers = {};
    
    usuariosDados.forEach(usuario => {
        if (!usuario.localizacaoAtual) return;
        
        const coresMarkers = {
            'offline': 'red',
            'online': 'green',
            'em_rota': 'orange'
        };
        
        const corMarker = coresMarkers[usuario.status] || 'grey';
        
        const marker = L.marker([usuario.localizacaoAtual.lat, usuario.localizacaoAtual.lng], {
            icon: L.icon({
                iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${corMarker}.png`,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })
        }).addTo(mapa).bindPopup(`<b>üë§ ${usuario.nome}</b><br>Role: ${usuario.role}<br>Status: ${usuario.status}`);
        
        usuariosMarkers[usuario.id] = marker;
    });
}

function mostrarTodosNoMapa() {
    mostrarPontosNoMapa();
    mostrarEquipesNoMapa();
    atualizarMarkerUsuario();
}

function calcularDistancias() {
    if (usuariosDados.length === 0 || pontosDados.length === 0) {
        alert('√â necess√°rio ter usu√°rios e pontos');
        return;
    }
    
    const lista = document.getElementById('lista-distancias');
    lista.innerHTML = '';
    
    const resultados = [];
    
    usuariosDados.forEach(usuario => {
        if (!usuario.localizacaoAtual) return;
        
        pontosDados.forEach(ponto => {
            const dist = calcularDistanciaHaversine(
                usuario.localizacaoAtual.lat, usuario.localizacaoAtual.lng,
                ponto.lat, ponto.lng
            );
            
            resultados.push({
                usuario: usuario.nome,
                ponto: ponto.nome,
                distancia: dist,
                status: usuario.status
            });
        });
    });
    
    resultados.sort((a, b) => a.distancia - b.distancia);
    
    resultados.forEach(r => {
        const div = document.createElement('div');
        div.style.cssText = 'padding: 4px; margin: 3px 0; background: white; border-radius: 2px;';
        const distTexto = r.distancia < 1 ? `${(r.distancia * 1000).toFixed(0)}m` : `${r.distancia.toFixed(2)}km`;
        div.innerHTML = `<small><b>${r.usuario}</b> ‚Üí ${r.ponto}</small><br><small>üìè ${distTexto}</small>`;
        lista.appendChild(div);
    });
    
    document.getElementById('distancias-info').style.display = 'block';
}

function calcularDistanciaHaversine(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function atualizarSelectTrafegoEquipes() {
    const select = document.getElementById('traffic-equipe-select');
    select.innerHTML = '<option value="">Sua localiza√ß√£o</option>';
    
    usuariosDados.forEach(usuario => {
        const option = document.createElement('option');
        option.value = usuario.id;
        option.textContent = `${usuario.nome} (${usuario.role})`;
        select.appendChild(option);
    });
    
    select.onchange = () => {
        const usuarioId = select.value;
        if (usuarioId) {
            const usuario = usuariosDados.find(u => u.id === usuarioId);
            if (usuario && usuario.localizacaoAtual) {
                atualizarTrafegoEmTempoReal(usuario.localizacaoAtual);
            }
        } else {
            atualizarTrafegoEmTempoReal();
        }
    };
}

async function atualizarTrafegoEmTempoReal(loc) {
    const localizacao = loc || localizacaoAtual;
    if (!localizacao) return;
    
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${localizacao.lat}&lon=${localizacao.lng}`);
        if (response.ok) {
            const data = await response.json();
            const cidade = data.address.city || data.address.town || 'Localiza√ß√£o';
            document.getElementById('traffic-location').textContent = cidade;
        }
    } catch (error) {
        document.getElementById('traffic-location').textContent = `${localizacao.lat.toFixed(2)}, ${localizacao.lng.toFixed(2)}`;
    }
    
    const hora = new Date().getHours();
    let trafego = '‚úÖ Normal';
    let cor = '#27ae60';
    
    if ((hora >= 7 && hora <= 9) || (hora >= 17 && hora <= 19)) {
        const opcoes = ['‚ö†Ô∏è Moderado', 'üö® Congestionado'];
        const idx = Math.floor(Math.random() * opcoes.length);
        trafego = opcoes[idx];
        cor = idx === 0 ? '#f39c12' : '#e74c3c';
    }
    
    document.getElementById('traffic-status').innerHTML = `
        <div style="background: ${cor}; color: white; padding: 8px; border-radius: 3px; margin: 5px 0; font-size: 12px; font-weight: bold;">
            ${trafego}
        </div>
        <small style="color: #666; margin-top: 3px; display: block;">
            Atualizado: ${new Date().toLocaleTimeString()}
        </small>
    `;
}

// CONTROLES
document.getElementById('iniciar-rastreamento').onclick = () => {
    rastreando = true;
    alert('‚úÖ Rastreamento iniciado!');
};

document.getElementById('parar-rastreamento').onclick = () => {
    rastreando = false;
    alert('‚è∏Ô∏è Pausado');
};

document.getElementById('centralizar-mapa').onclick = () => {
    if (localizacaoAtual) {
        mapa.setView([localizacaoAtual.lat, localizacaoAtual.lng], 15);
    }
};

document.getElementById('mostrar-usuario').onclick = () => {
    if (localizacaoAtual) {
        mapa.setView([localizacaoAtual.lat, localizacaoAtual.lng], 15);
        atualizarMarkerUsuario();
    }
};

document.getElementById('mostrar-pontos').onclick = mostrarPontosNoMapa;
document.getElementById('mostrar-equipes').onclick = mostrarEquipesNoMapa;
document.getElementById('mostrar-todos').onclick = mostrarTodosNoMapa;
document.getElementById('calcular-distancias').onclick = calcularDistancias;

document.getElementById('limpar-mapa').onclick = () => {
    Object.values(pontosMarkers).forEach(m => mapa.removeLayer(m));
    Object.values(usuariosMarkers).forEach(m => mapa.removeLayer(m));
    if (usuarioMarker) mapa.removeLayer(usuarioMarker);
    pontosMarkers = {};
    usuariosMarkers = {};
    usuarioMarker = null;
};

setInterval(() => atualizarTrafegoEmTempoReal(), 30000);

}); // Fim DOMContentLoaded
</script>

</body>
</html>
